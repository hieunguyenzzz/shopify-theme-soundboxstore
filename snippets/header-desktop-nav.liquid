{%- liquid
  unless limit
    assign limit = main_menu.links.size
  endunless
  unless offset
    assign offset = 0
  endunless
-%}

<ul class="site-nav site-navigation site-navigation--{{ nav_position }} small--hide" role="navigation">
  {%- for link in main_menu.links limit: limit offset: offset -%}
    {%- liquid
      assign has_dropdown = false
      assign is_megamenu = false
      if link.levels > 0
        assign has_dropdown = true
        if link.levels > 0
          assign is_megamenu = true
        endif
      endif

      assign isCollection = false
      if show_mega_products
        if is_megamenu and link.url contains '/collections/'
          assign lang_code_string = request.locale.iso_code | prepend: '/' | downcase
          assign collection_handle = link.url | remove: '/collections/' | remove: lang_code_string
          assign collection_drop = collections[collection_handle]
          assign isCollection = true
        endif
      endif
    -%}

    <li class="site-nav__item site-nav__expanded-item{% if has_dropdown %} site-nav--has-dropdown{% endif %}{% if is_megamenu %} site-nav--is-megamenu{% endif %}" {% if has_dropdown %} aria-haspopup="true" {% endif %}>

      <a href="{{ link.url }}" class="site-nav__link site-nav__link--underline{% if has_dropdown %} site-nav__link--has-dropdown{% endif %}">
        {{ link.title }}
      </a>
      {%- if is_megamenu -%}
        {%- assign previous_column_type = '' -%}
        <div class="site-nav__dropdown megamenu text-left">
          <div class="page-width">
            <div class="site-nav__dropdown-animate megamenu__wrapper">
              <div class="megamenu__cols">

                {%- for childlink in link.links -%}
                  <div class="megamenu__col">
                    {%- liquid
                      assign create_new_column = false

                      if childlink.levels > 0 and forloop.index != 1
                        assign create_new_column = true
                      endif

                      if childlink.levels == 0 and previous_column_type == 'full'
                        assign create_new_column = true
                      endif
                    -%}

                    {%- if create_new_column -%}
                    </div>
                    <div class="megamenu__col">
                    {%- endif -%}


                    <div class="megamenu-col-wrap">

                      {% if childlink.url contains '/products/' %}
                        {% for product in collections[section.settings.collection_products].products %}
                          {% if childlink.url == product.url %}
                            <div class="menu-col-image" style="position: relative;">
                              <a href="{{ childlink.url }}" class="site-nav__dropdown-link site-nav__dropdown-link--top-level">
                                <img loading="lazy" src={{ product.featured_image | img_url :'compact' }}/>
                              </a>
                              {% assign current_variant =  product.selected_or_first_available_variant %}
                              {% assign discount = nil %}
                              {% if current_variant.price < current_variant.compare_at_price %}
                                  {% capture discount %}
                                      {{ current_variant.compare_at_price | minus:current_variant.price | times:10.000 | divided_by:current_variant.compare_at_price | round | append: '0' }}%
                                  {% endcapture %}
                              {% endif %}
                             {% if discount %}
                                   <div class="new-label"><svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin meet" viewBox="0 0 200 200">
                                  <circle cx="100" cy="100" r="100" fill="#00000091" id="background"></circle>
                                  <g>
                                    <path id="svg-text" d="M 0 100 H 200" fill="transparent" stroke="transparent"></path>
                                    <text fill="#fff" stroke-width="1px" font-size="66px" x="100" y="100" dy="25px" text-anchor="middle">
                                      <textPath xlink:href="#svg-text" method="stretch" lengthAdjust="spacingAndGlyphs">-{{ discount }}</textPath>
                                    </text>
                                  </g>
                                </svg></div>
                                   {% else %}
                               {% for c in product.collections %}
                                {% if c.handle == "new" %}
                                <div class="new-label"><svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin meet" viewBox="0 0 200 200">
                                  <circle cx="100" cy="100" r="100" fill="#00000091" id="background"></circle>
                                  <g>
                                    <path id="svg-text" d="M 0 100 H 200" fill="transparent" stroke="transparent"></path>
                                    <text fill="#fff" stroke-width="1px" font-size="66px" x="100" y="100" dy="25px" text-anchor="middle">
                                      <textPath xlink:href="#svg-text" method="stretch" lengthAdjust="spacingAndGlyphs">NEW</textPath>
                                    </text>
                                  </g>
                                </svg></div>
                                {% endif %}
                              {% endfor %}
                              {% endif %}
                              
                              
                            </div>
                            <h4>
                              <a href="{{ childlink.url }}">{{ product.title }}</a>
                            </h4>
                          {% endif %}
                        {% endfor %}

                      {% else if childlink.url contains '/collections/' %}
                        {% for collection in collections %}
                          {% if childlink.url == collection.url %}
                            <div class="menu-col-image">
                              <a href="{{ childlink.url }}" class="site-nav__dropdown-link site-nav__dropdown-link--top-level">
                                <img loading="lazy" src={{ collection.featured_image | img_url:'compact' }}/>
                              </a>
                            </div>
                            <h4>
                              <a href="{{ childlink.url }}">{{ childlink.title }}</a>
                            </h4>
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    </div>

                    {%- liquid
                      if childlink.levels > 0
                        assign previous_column_type = 'full'
                      else
                        assign previous_column_type = 'single'
                      endif
                    -%}

                    {%- for grandchildlink in childlink.links -%}
                      <a href="{{ grandchildlink.url }}" class="site-nav__dropdown-link">
                        {{grandchildlink.title}}
                      </a>
                    {%- endfor -%}
                  </div>
                {%- endfor -%}
                <div class="megamenu__col">
                  <div class="megamenu-col-wrap">
                    <a href="/collections/all">{{ 'strings.others.shop_all' | t }}</a>
                  </div>
                </div>


              </div>
              {%- if isCollection -%}
                {% comment %}
                <div class="megamenu__featured">
                  <div class="product-grid">
                    {%- liquid
                      assign mega_product = collection_drop.products.first
                      render 'product-grid-item', product: mega_product

                      if settings.quick_shop_enable
                        render 'quick-shop-modal', product: mega_product
                      endif
                    -%}
                  </div>
                </div>
              {% endcomment %}
              {%- endif -%}
            </div>
          </div>
        </div>
      {%- elsif has_dropdown -%}
        <div class="site-nav__dropdown">
          <ul class="site-nav__dropdown-animate site-nav__dropdown-list text-left">
            {%- for childlink in link.links -%}
              {%- liquid
                assign has_sub_dropdown = false
                if childlink.levels > 0
                  assign has_sub_dropdown = true
                endif
              -%}

              <li class="{% if has_sub_dropdown %} site-nav__deep-dropdown-trigger{% endif %}">
                <a href="{{ childlink.url }}" class="site-nav__dropdown-link site-nav__dropdown-link--second-level{% if has_sub_dropdown %} site-nav__dropdown-link--has-children{% endif %}">
                  <img loading="lazy" src="{{ childlink.featured_image | img_url }}"/>
                  {{ childlink.title | escape }}
                  {%- if has_sub_dropdown -%}
                    <svg aria-hidden="true" class="icon icon--wide icon-chevron-down" focusable="false" role="presentation" viewbox="0 0 28 16"><path d="M1.57 1.59l12.76 12.77L27.1 1.59" fill-rule="evenodd" fill="none" stroke-width="2" stroke="#000"/></svg>
                  {%- endif -%}
                </a>
                {%- if has_sub_dropdown -%}
                  <ul class="site-nav__deep-dropdown">
                    {%- for grandchildlink in childlink.links -%}
                      <li>
                        <a href="{{ grandchildlink.url }}" class="site-nav__dropdown-link">{{ grandchildlink.title | escape }}</a>
                      </li>
                    {%- endfor -%}
                  </ul>
                {%- endif -%}
              </li>
            {%- endfor -%}
          </ul>
        </div>
      {%- endif -%}
    </li>
  {%- endfor -%}
</ul>
